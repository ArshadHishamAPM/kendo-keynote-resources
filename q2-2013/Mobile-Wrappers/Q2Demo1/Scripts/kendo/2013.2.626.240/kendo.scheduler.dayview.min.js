/*
* Kendo UI Beta v2013.2.626 (http://kendoui.com)
* Copyright 2013 Telerik AD. All rights reserved.
*
* Kendo UI Beta license terms available at
* http://www.kendoui.com/purchase/license-agreement/kendo-ui-beta.aspx
*/

("function"==typeof define&&define.amd?define:function(e,t){return t()})(["./kendo.scheduler.view.min"],function(){!function(e){function t(e){var t=new Date(1980,1,1,0,0,0);return i.date.setTime(t,m(e)),t}function a(e,t,a){var n,i=t.getTime(),s=a.getTime();return n=e.getTime(),n>=i&&s>=n}function n(e,t,a){var n,i=m(t),s=m(a);return e&&i!=s?(t>=a&&(a+=h),n=m(e),i>n&&(n+=h),i>s&&(s+=h),n>i&&s>n):!0}var i=window.kendo,s=i.ui,r=s.SchedulerView,d=e.extend,o=e.proxy,l=i.date.getDate,c=i.date.MS_PER_MINUTE,h=i.date.MS_PER_DAY,m=i.date.getMilliseconds,u=".kendoMultiDayView",p=i.template('<div title="(#=kendo.format("{0:t} - {1:t}", start, end)#): #=title#"><dl><dt>#=kendo.format("{0:t} - {1:t}", start, end)#</dt><dd>${title}</dd></dl></div>'),f=i.template('<div title="(#=kendo.format("{0:t}", start)#): #=title#"><dl><dd>${title}</dd></dl></div>'),v=i.template("<span class='k-link k-nav-day'>#=kendo.toString(date, 'ddd M/dd')#</span>"),T='<div class="k-event" data-#=ns#uid="#=uid#"#if (resources[0]) { #style="background-color:#=resources[0].color #"#}#><span class="k-event-actions"># if(data.tail || data.middle) {#<span class="k-icon k-i-arrow-w"></span>#}## if(data.id && data.recurrenceId) {#<span class="k-icon k-i-exception"></span># } else if(data.recurrenceRule || data.recurrenceId) {#<span class="k-icon k-i-refresh"></span># } #</span>{0}<span class="k-event-actions">#if (showDelete) {#<a href="\\#" class="k-link k-event-delete"><span class="k-icon k-i-close"></span></a>#}## if(data.head || data.middle) {#<span class="k-icon k-i-arrow-e"></span>#}#</span></div>',g='<div class="k-event" data-#=ns#uid="#=uid#"#if (resources[0]) { #style="background-color:#=resources[0].color #"#}#><span class="k-event-actions"># if(data.id && data.recurrenceId) {#<span class="k-icon k-i-exception"></span># } else if(data.recurrenceRule || data.recurrenceId) {#<span class="k-icon k-i-refresh"></span># } #</span>{0}<span class="k-event-actions">#if (showDelete) {#<a href="\\#" class="k-link k-event-delete"><span class="k-icon k-i-close"></span></a>#}#</span><span class="k-event-top-actions"># if(data.tail || data.middle) {#<span class="k-icon k-i-arrow-n"></span>#}#</span><span class="k-event-bottom-actions"># if(data.head || data.middle) {#<span class="k-icon k-i-arrow-s"></span>#}#</span></div>',k=r.extend({init:function(e,t){var a=this;r.fn.init.call(a,e,t),a.title=a.options.title||a.options.name,a._templates(),a._editable(),a.calculateDateRange()},options:{name:"MultiDayView",selectedDateFormat:"{0:D}",allDaySlot:!0,title:"",startTime:i.date.today(),endTime:i.date.today(),minorTickCount:2,majorTick:60,majorTimeHeaderTemplate:"#=kendo.toString(date, 't')#",minorTimeHeaderTemplate:"&nbsp;",eventTemplate:p,allDayEventTemplate:f,dateHeaderTemplate:v,editable:!0},events:["remove","add","edit"],_templates:function(){var e=this.options,t=d({},i.Template,e.templateSettings);this.eventTemplate=this._eventTmpl(e.eventTemplate,g),this.allDayEventTemplate=this._eventTmpl(e.allDayEventTemplate,T),this.majorTimeHeaderTemplate=i.template(e.majorTimeHeaderTemplate,t),this.minorTimeHeaderTemplate=i.template(e.minorTimeHeaderTemplate,t),this.dateHeaderTemplate=i.template(e.dateHeaderTemplate,t)},_editable:function(){var t=this;t.options.editable&&(t.element.on("click"+u,".k-event a:has(.k-i-close)",function(a){t.trigger("remove",{uid:e(this).closest(".k-event").attr(i.attr("uid"))}),a.preventDefault()}),t.options.editable.create!==!1&&t.element.on("dblclick"+u,".k-scheduler-content td",function(a){var n=e(this);t.trigger("add",{eventInfo:t._rangeToDates(n)}),a.preventDefault()}).on("dblclick"+u,".k-scheduler-header-all-day td",function(a){var n=e(this);t.trigger("add",{eventInfo:d({isAllDay:!0},t._rangeToDates(n))}),a.preventDefault()}),t.options.editable.update!==!1&&t.element.on("dblclick"+u,".k-event",function(a){t.trigger("edit",{uid:e(this).closest(".k-event").attr(i.attr("uid"))}),a.preventDefault()}))},_layout:function(e){var t,a,n=[],s=[],r=this.options,d=this;for(t=0;t<e.length;t++)a={},a.text=d.dateHeaderTemplate({date:e[t]}),i.date.isToday(e[t])&&(a.className="k-today"),n.push(a);return r.allDaySlot&&s.push({text:"all day",allDay:!0}),this._forTimeRange(r.startTime,r.endTime,function(e,t,a,n){var i=t?d.majorTimeHeaderTemplate:d.minorTimeHeaderTemplate,r={text:i({date:e}),className:n?"k-slot-cell":""};s.push(r)}),{columns:n,rows:s}},_footer:function(){var t='<div class="k-header k-scheduler-footer">&nbsp;';t+="</div>",this.footer=e(t).appendTo(this.element)},_forTimeRange:function(e,a,n,s){var r,d,o,l,u,p,f,v,T,g,k,D,_,y,w,H;for(e=t(e),a=t(a),o=this,l=m(e),u=m(a),p=o.options.minorTickCount,f=o.options.majorTick*c,v=f/p||1,T=new Date(+e),g=T.getDate(),k=0,D="",d=h/v,l!=u&&(l>u&&(u+=h),d=(u-l)/v),d=Math.round(d);d>k;k++)_=k%(f/v),y=0===_,w=p-1>_,H=_===p-1,D+=n(T,y,w,H),i.date.setTime(T,v,!1);return u&&(r=m(T),g<T.getDate()&&(r+=h),r>u&&(T=new Date(+a))),s&&(D+=s(T)),D},_content:function(e){var t=this,a=t.options,n=a.startTime,s=a.endTime,r="";r+="<tbody>",r+=this._forTimeRange(n,s,function(t,a,n){var s,r,d="";for(d="<tr"+(n?' class="k-middle-row"':"")+">",s=0,r=e.length;r>s;s++)d+="<td"+(i.date.isToday(e[s])?' class="k-today"':"")+">",d+="&nbsp;</td>";return d+="</tr>"}),r+="</tbody>",this.content.find("table").append(r)},_render:function(t){var a,n=this;t=t||[],this._dates=t,this._startDate=t[0],this._endDate=t[t.length-1||0],this.createLayout(this._layout(t)),this._content(t),this._footer(),this.refreshLayout(),a=this.element.find(".k-scheduler-header-all-day td"),a.length&&(this._allDayHeaderHeight=a.first()[0].clientHeight),n.datesHeader.on("click"+u,".k-nav-day",function(t){var a=e(t.currentTarget).closest("th");n.trigger("navigate",{view:"day",date:n._slotIndexDate(a.index())})})},startDate:function(){return this._startDate},endDate:function(){return this._endDate},nextDate:function(){return i.date.nextDay(this.endDate())},previousDate:function(){return i.date.previousDay(this.startDate())},calculateDateRange:function(){this._render([this.options.date])},destroy:function(){var e=this;e.datesHeader&&e.datesHeader.off(u),e.element&&e.element.off(u),r.fn.destroy.call(this),e.footer&&e.footer.remove()},_rangeToDates:function(e){var t,a=e.closest("tr"),n=a.closest("table").find("tr"),s=n.length-1,r=a.find("td").index(e),d=n.index(a),o=i.date.getDate(this._slotIndexDate(r));return o?(t=i.date.getDate(o),i.date.setTime(o,this._slotIndexTime(d)),i.date.setTime(t,this._slotIndexTime(Math.min(d+1,s))),{start:o,end:t}):null},_slotIndexTime:function(e){var t=this.options,a=m(t.startTime),n=t.majorTick/t.minorTickCount*c;return a+n*e},_slotIndexDate:function(e){var t,a,n,s=this._dates||[],r=m(new Date(+this.options.startTime)),d=m(new Date(+this.options.endTime));for(r>=d&&(d+=h),t=0,a=s.length;a>t;t++)if(n=new Date(+s[t]),i.date.setTime(n,r),e===t)return n;return null},_timeSlotIndex:function(e){var t=this.options,a=m(e),n=m(t.startTime),i=t.majorTick/t.minorTickCount*c;return(a-n)/i},_dateSlotIndex:function(e){var t,n,s,r,d=this._dates||[];for(t=0,n=d.length;n>t;t++)if(s=i.date.getDate(d[t]),r=new Date(i.date.getDate(d[t]).getTime()+h-1),a(e,s,r))return t;return-1},_calculateAllDayEventWidth:function(e,t){var a,n,i=this.element.find(".k-scheduler-header-all-day td"),s=0,r=e!==t?"outerWidth":"innerWidth";for(a=0,n=i.length;n>a;a++)a>=e&&t>=a&&(s+=i.eq(a)[r]());return s},_calculateEventHeight:function(e,t,a){var n,i,s=0;for(t===a&&(a+=1),n=0,i=e.length;i>n;n++)n>=t&&a>n&&(s+=e.eq(n).innerHeight());return s},_positionAllDayEvent:function(t,a,n,s){var d,o,l,c,h,m,u=a.eq(n),p=this._calculateAllDayEventWidth(n,s),f=r.collidingHorizontallyEvents(this.datesHeader.find(".k-event"),n,s).add(t),v=u.position().top,T=this._headerColumnCount||0,g=2,k=n!==s?5:4,D=this._allDayHeaderHeight;for(t.css({left:u.position().left+g,width:p-k}),t.attr(i.attr("start-end-idx"),n+"-"+s),d=r.createRows(f),o=0,l=d.length;l>o;o++)for(c=d[o].events,h=0,m=c.length;m>h;h++)e(c[h]).css({top:v+o*D});d.length&&d.length>T&&(this._updateAllDayHeaderHeight(D*d.length+D),this._headerColumnCount=d.length)},_arrangeColumns:function(t,a,n){var s,d,o,l,c,h=n.width(),m=.05*h,u=r.rangeIndex(t),p=this.content.children(".k-event["+i.attr("slot-idx")+"="+a+"]"),f=r.collidingEvents(p,u.start,u.end).add(t),v=r.createColumns(f),T=(h-m)/v.length;for(d=0,o=v.length;o>d;d++)for(s=v[d].events,l=0,c=s.length;c>l;l++)e(s[l]).css({width:T-4,left:n[0].offsetLeft+d*T+2})},_positionEvent:function(e,t,a,n){var s=Math.max(Math.floor(this._timeSlotIndex(e.startTime||e.start)),0),r=Math.min(Math.ceil(this._timeSlotIndex(e.endTime||e.end)),a.length),d=a.eq(Math.floor(s)),o=4,l=d.children().eq(n);s>=0&&0===r&&(r=a.length),t.css({height:this._calculateEventHeight(a,s,r)-o,top:d.position().top+this.content[0].scrollTop}),t.attr(i.attr("slot-idx"),n),t.attr(i.attr("start-end-idx"),s+"-"+r),this._arrangeColumns(t,n,l)},_eventTmpl:function(e,t){var a,n=this.options,s=d({},i.Template,n.templateSettings),r=s.paramName,l="",c=typeof e,h={storage:{},count:0};return"function"===c?(h.storage["tmpl"+h.count]=e,l+="#=this.tmpl"+h.count+"("+r+")#",h.count++):"string"===c&&(l+=e),a=i.template(i.format(t,l),s),h.count>0&&(a=o(a,h.storage)),a},_createEventElement:function(t,n,s){var r,o,c,u=this.options,p=u.editable&&u.editable.destroy!==!1,f=l(this.startDate()),v=l(this.endDate()),T=m(u.startTime),g=m(u.endTime),k=m(t.startTime||t.start),D=m(t.endTime||t.end);return T>=g&&(g=new Date(u.endTime.getTime()+h-1)),!a(l(t.start),f,v)||s&&T>k&&D>g?r=!0:l(t.start)<f||s&&T>k?c=!0:(l(t.end)>v||s&&D>g)&&(o=!0),e(n(d({},{ns:i.ns,showDelete:p,middle:r,head:o,tail:c,resources:this.eventResources(t)},t,{start:t.startTime||t.start,end:t.endTime||t.end})))},_isInTimeSlot:function(e){var t=this.options.startTime,a=this.options.endTime,i=e.startTime||e.start,s=e.endTime||e.end;return n(i,t,a)||n(s,t,a)||n(t,i,s)||n(a,i,s)},_isInDateSlot:function(e){var t=this.startDate(),n=new Date(this.endDate().getTime()+h-1);return a(e.start,t,n)||a(e.end,t,n)||a(t,e.start,e.end)||a(n,e.start,e.end)},_updateAllDayHeaderHeight:function(e){var t=this.element.find(".k-scheduler-header-all-day td");t.length&&t.parent().add(this.timesHeader.find(".k-scheduler-times-all-day").parent()).height(e)},render:function(e){var t,a,n,s,r,d,o,l,c=this.eventTemplate,m=this.allDayEventTemplate,u=this.content.find("tr"),p=this.element.find(".k-scheduler-header-all-day td"),f=this.datesHeader.find(".k-scheduler-header-wrap");for(this._headerColumnCount=0,this.element.find(".k-event").remove(),this._updateAllDayHeaderHeight(this._allDayHeaderHeight),e=new i.data.Query(e).sort([{field:"start",dir:"asc"},{field:"end",dir:"desc"}]).toArray(),a=0,n=e.length;n>a;a++)t=e[a],this._isInDateSlot(t)&&(s=this._dateSlotIndex(t.start),r=this._dateSlotIndex(t.end),d=!t.isAllDay&&t.end.getTime()-t.start.getTime()<h&&s===r,o=d?this.content:f,l=this._createEventElement(t,d?c:m,d),d?this._isInTimeSlot(t)&&(-1===s&&r>-1&&(s=r),this._positionEvent(t,l,u,s),l.appendTo(o)):p.length&&(0>s&&(s=0),0>r&&(r=p.length-1),this._positionAllDayEvent(l,p,s,r),l.appendTo(o)));this.refreshLayout()}});d(!0,s,{MultiDayView:k,DayView:k.extend({options:{title:"Day"},name:"day"}),WeekView:k.extend({options:{title:"Week",selectedDateFormat:"{0:D} - {1:D}"},name:"week",calculateDateRange:function(){var e,t,a=this.options.date,n=i.date.dayOfWeek(a,0,-1),s=[];for(e=0,t=7;t>e;e++)s.push(n),n=i.date.nextDay(n);this._render(s)}})})}(window.kendo.jQuery)});